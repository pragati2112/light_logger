<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

<div id="app">
    <p style=" font-size: 3rem; text-align: center;">{{ message }}</p>
    <br>
    <div style="text-align: center; ">
        <button type="button" style="padding: 0.1rem;
            align-content: center"
            @click="fetchLogs">Show latest logs
        </button>
        &nbsp;

        <input type="date" v-model="start_date" name="Start date">
        &nbsp;
        <input type="date" v-model="end_date"  name="End date">
        &nbsp;
        <input type="submit" @click="fetchLogs">

        &nbsp;
        <button type="button" style="padding: 0.1rem;
            align-content: center"
            @click="resetFilters">Reset
        </button>


    </div>

    <div v-if="logs.length>0 && is_data_ready">

        <p>Logs for -
            <u><b>{{new Date(start_date).toDateString()}} - {{new Date(end_date).toDateString()}}</b></u>
            (Latest first)
        </p>

        <div  v-for="(log,idx) in logs">
            {{log}}
        </div>
    </div>
</div>

<script>
  const { createApp } = Vue

  createApp({
    data() {
      return {
        message: 'Hello light logger!',
        connection: null,
        per_page:50,
        logs:[],
        start_date:new Date(),
        end_date:new Date(),
        is_data_ready:false
      }
    },

    created: function() {
        console.log("Starting connection to WebSocket Server")
        this.connection = new WebSocket("ws://127.0.0.1:8001/ws")

        let self = this
        self.connection.onmessage = function(event) {
            // const resp = JSON.parse(event.data)
            // self.page_number = resp.page_no
            // self.per_page = resp.per_page

            if(event){
                self.logs.push(event.data)
                self.is_data_ready = true
            }
        }

        self.connection.onopen = function(event) {
          console.log(event)
          console.log("Successfully connected to the echo websocket server...")
        }
    },

    mounted(){
        window.addEventListener('scroll', this.loadMore)
    },

    methods:{
        formattedDate:function(d){
            let date = new Date(d)
            let year = date.toLocaleDateString("default", { year: "numeric" });
            let month = date.toLocaleDateString("default", { month: "2-digit" });
            let day = date.toLocaleDateString("default", { day: "2-digit" });
            return year + "-" + month + "-" + day
        },

        fetchLogs: function (){
            let data = {
                start_date: this.formattedDate(this.start_date),
                end_date: this.formattedDate(this.end_date),
                per_page:50,
            }
            this.connection.send(JSON.stringify(data))
        },

        loadMore: function (event){
            if (this.is_data_ready){
                let data = {
                    start_date: this.formattedDate(this.start_date),
                    end_date: this.formattedDate(this.end_date),
                    per_page:50,
                }
                this.connection.send(JSON.stringify(data))
            }
        },

        resetFilters: function (){
            this.start_date=new Date()
            this.end_date = new Date()
            this.logs=[]
            this.is_data_ready = false
        },

    },

    destroyed () {
        window.removeEventListener('scroll', this.loadMore);
    },


  }).mount('#app')
</script>

<style>
    body{
        background-color: rgb(236, 236, 236);
        width: 100%;
        height: 100%;
    }
</style>
